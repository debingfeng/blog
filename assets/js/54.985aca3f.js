(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{209:function(e,t,n){"use strict";n.r(t);var r=n(0),a=Object(r.a)({},function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"content"},[e._m(0),e._v(" "),n("p"),e._m(1),n("p"),e._v(" "),n("p",[e._v("有一天，我们写了关于如何在localStorage中保存图像和文件的文章，它是关于我们今天可用的实用主义。 然而，localStorage有一些性能影响 - 我们将在稍后的博客中讨论这个问题 - 并且未来期望的方法是使用IndexedDB。 在这里，我将向您介绍如何在IndexedDB中存储图像和文件，然后通过ObjectURL呈现它们。")]),e._v(" "),n("p",[n("strong",[e._v("本文是翻译过来的，原文在这里"),n("a",{attrs:{href:"https://hacks.mozilla.org/2012/02/storing-images-and-files-in-indexeddb/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Storing images and files in IndexedDB"),n("OutboundLink")],1)])]),e._v(" "),n("p",[n("strong",[e._v("关于作者： "),n("a",{attrs:{href:"https://robertnyman.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Robert Nyman [Editor emeritus]"),n("OutboundLink")],1)])]),e._v(" "),n("p",[e._v("Technical Evangelist & Editor of Mozilla Hacks. Gives talks & blogs about HTML5, JavaScript & the Open Web. Robert is a strong believer in HTML5 and the Open Web and has been working since 1999 with Front End development for the web - in Sweden and in New York City. He regularly also blogs at http://robertnyman.com and loves to travel and meet people.")]),e._v(" "),e._m(2),e._v(" "),n("p",[e._v("首先，我们来谈谈我们将创建一个IndexedDB数据库，将文件保存到其中然后将其读出并显示在页面中的步骤：")]),e._v(" "),e._m(3),e._v(" "),e._m(4),e._v(" "),e._m(5),n("p",[e._v("使用它的预期方法是在创建数据库时触发onupgradeneeded事件或获取更高版本号。 目前仅在Firefox中支持此功能，但很快将在其他Web浏览器中支持。 如果Web浏览器不支持此事件，则可以使用已弃用的setVersion方法并连接到其onsuccess事件。")]),e._v(" "),e._m(6),e._v(" "),e._m(7),n("p",[e._v("在这里，您创建一个ObjectStore，您将存储数据 - 或者在我们的例子中，文件 - 并且一旦创建，您不需要重新创建它，只需更新其内容即可。")]),e._v(" "),e._m(8),e._v(" "),e._m(9),n("p",[e._v("此代码直接将文件的内容作为blob获取。目前只支持Firefox。 收到整个文件后，将blob发送到函数以将其存储在数据库中。")]),e._v(" "),e._m(10),e._v(" "),e._m(11),n("p",[e._v("要开始向数据库写入内容，您需要使用objectStore名称和要执行的操作类型（在本例中为read和write）启动事务。")]),e._v(" "),e._m(12),e._v(" "),e._m(13),n("p",[e._v("一旦事务到位，您将获得对所需objectStore的引用，然后将您的blob放入其中并为其提供密钥。")]),e._v(" "),e._m(14),e._v(" "),e._m(15),n("p",[e._v("使用相同的事务来获取刚刚存储的图像文件，然后创建一个objectURL并将其设置为页面中图像的src。\n例如，这也可以是一个附加到脚本元素的JavaScript文件，然后它将解析JavaScript。")]),e._v(" "),e._m(16),e._v(" "),e._m(17),e._m(18),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://caniuse.com/#search=URL",target:"_blank",rel:"noopener noreferrer"}},[e._v("URL API支持性"),n("OutboundLink")],1)])]),e._v(" "),e._m(19),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://caniuse.com/#search=indexDb",target:"_blank",rel:"noopener noreferrer"}},[e._v("indexDb"),n("OutboundLink")],1)])]),e._v(" "),e._m(20),e._v(" "),n("h3",{attrs:{id:"github源码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#github源码","aria-hidden":"true"}},[e._v("#")]),e._v(" "),n("a",{attrs:{href:"https://github.com/robnyman/robnyman.github.com/tree/master/html5demos/indexeddb",target:"_blank",rel:"noopener noreferrer"}},[e._v("Github源码"),n("OutboundLink")],1)])])},[function(){var e=this.$createElement,t=this._self._c||e;return t("h1",{attrs:{id:"使用indexdb存储图像和文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用indexdb存储图像和文件","aria-hidden":"true"}},[this._v("#")]),this._v(" 使用IndexDB存储图像和文件")])},function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#使用indexdb存储图像和文件的常规步骤"}},[e._v("使用IndexDB存储图像和文件的常规步骤")]),n("ul",[n("li",[n("a",{attrs:{href:"#_1、创建或打开数据库。"}},[e._v("1、创建或打开数据库。")])]),n("li",[n("a",{attrs:{href:"#_2、创建一个objectstore（如果它尚不存在）"}},[e._v("2、创建一个objectStore（如果它尚不存在）")])]),n("li",[n("a",{attrs:{href:"#_3、将图像文件检索为blob"}},[e._v("3、将图像文件检索为blob")])]),n("li",[n("a",{attrs:{href:"#_4、初始化一个数据库事物"}},[e._v("4、初始化一个数据库事物")])]),n("li",[n("a",{attrs:{href:"#_5、保存图像blob到数据库中去"}},[e._v("5、保存图像blob到数据库中去")])]),n("li",[n("a",{attrs:{href:"#_6、读出保存的文件并从中创建objecturl并将其设置为页面中图像元素的src"}},[e._v("6、读出保存的文件并从中创建ObjectURL并将其设置为页面中图像元素的src")])]),n("li",[n("a",{attrs:{href:"#最后完整代码"}},[e._v("最后完整代码")])]),n("li",[n("a",{attrs:{href:"#浏览器支持"}},[e._v("浏览器支持")])]),n("li",[n("a",{attrs:{href:"#github源码-https-github-com-robnyman-robnyman-github-com-tree-master-html5demos-indexeddb"}},[e._v("Github源码")])])])])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"使用indexdb存储图像和文件的常规步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用indexdb存储图像和文件的常规步骤","aria-hidden":"true"}},[this._v("#")]),this._v(" 使用IndexDB存储图像和文件的常规步骤")])},function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ul",[n("li",[e._v("1、创建或打开数据库")]),e._v(" "),n("li",[e._v("2、创建一个objectStore")]),e._v(" "),n("li",[e._v("3、将图像文件检索为blob")]),e._v(" "),n("li",[e._v("4、初始化一个数据库事物")]),e._v(" "),n("li",[e._v("5、保存图像blob到数据库中去")]),e._v(" "),n("li",[e._v("6、读出保存的文件并从中创建ObjectURL并将其设置为页面中图像元素的src")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"_1、创建或打开数据库。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、创建或打开数据库。","aria-hidden":"true"}},[this._v("#")]),this._v(" 1、创建或打开数据库。")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v('\n// IndexedDB\nwindow.indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.OIndexedDB || window.msIndexedDB,\n    IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.OIDBTransaction || window.msIDBTransaction,\n    dbVersion = 1;\n\n/* \n    Note: The recommended way to do this is assigning it to window.indexedDB,\n    to avoid potential issues in the global scope when web browsers start \n    removing prefixes in their implementations.\n    You can assign it to a varible, like var indexedDB… but then you have \n    to make sure that the code is contained within a function.\n*/\n\n// Create/open database\nvar request = indexedDB.open("elephantFiles", dbVersion);\n\nrequest.onsuccess = function (event) {\n    console.log("Success creating/accessing IndexedDB database");\n    db = request.result;\n\n    db.onerror = function (event) {\n        console.log("Error creating/accessing IndexedDB database");\n    };\n    \n    // Interim solution for Google Chrome to create an objectStore. Will be deprecated\n    if (db.setVersion) {\n        if (db.version != dbVersion) {\n            var setVersion = db.setVersion(dbVersion);\n            setVersion.onsuccess = function () {\n                createObjectStore(db);\n                getImageFile();\n            };\n        }\n        else {\n            getImageFile();\n        }\n    }\n    else {\n        getImageFile();\n    }\n}\n\n// For future use. Currently only in latest Firefox versions\nrequest.onupgradeneeded = function (event) {\n    createObjectStore(event.target.result);\n};\n')])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"_2、创建一个objectstore（如果它尚不存在）"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、创建一个objectstore（如果它尚不存在）","aria-hidden":"true"}},[this._v("#")]),this._v(" 2、创建一个objectStore（如果它尚不存在）")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v('// Create an objectStore\nconsole.log("Creating objectStore")\ndataBase.createObjectStore("elephants");\n\n')])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"_3、将图像文件检索为blob"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、将图像文件检索为blob","aria-hidden":"true"}},[this._v("#")]),this._v(" 3、将图像文件检索为blob")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v('// Create XHR\nvar xhr = new XMLHttpRequest(),\n    blob;\n\nxhr.open("GET", "elephant.png", true);\n// Set the responseType to blob\nxhr.responseType = "blob";\n\nxhr.addEventListener("load", function () {\n    if (xhr.status === 200) {\n        console.log("Image retrieved");\n        \n        // File as response\n        blob = xhr.response;\n\n        // Put the received blob into IndexedDB\n        putElephantInDb(blob);\n    }\n}, false);\n// Send XHR\nxhr.send();\n')])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"_4、初始化一个数据库事物"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4、初始化一个数据库事物","aria-hidden":"true"}},[this._v("#")]),this._v(" 4、初始化一个数据库事物")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v('\n// Open a transaction to the database\nvar transaction = db.transaction(["elephants"], IDBTransaction.READ_WRITE);\n\n')])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"_5、保存图像blob到数据库中去"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5、保存图像blob到数据库中去","aria-hidden":"true"}},[this._v("#")]),this._v(" 5、保存图像blob到数据库中去")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v('// Put the blob into the dabase\ntransaction.objectStore("elephants").put(blob, "image");\n\n')])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"_6、读出保存的文件并从中创建objecturl并将其设置为页面中图像元素的src"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6、读出保存的文件并从中创建objecturl并将其设置为页面中图像元素的src","aria-hidden":"true"}},[this._v("#")]),this._v(" 6、读出保存的文件并从中创建ObjectURL并将其设置为页面中图像元素的src")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v('// Retrieve the file that was just stored\ntransaction.objectStore("elephants").get("image").onsuccess = function (event) {\n    var imgFile = event.target.result;\n    console.log("Got elephant!" + imgFile);\n\n    // Get window.URL object\n    var URL = window.URL || window.webkitURL;\n\n    // Create and revoke ObjectURL\n    var imgURL = URL.createObjectURL(imgFile);\n\n    // Set img src to ObjectURL\n    var imgElephant = document.getElementById("elephant");\n    imgElephant.setAttribute("src", imgURL);\n\n    // Revoking ObjectURL\n    URL.revokeObjectURL(imgURL);\n};\n')])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"最后完整代码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#最后完整代码","aria-hidden":"true"}},[this._v("#")]),this._v(" 最后完整代码")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v('(function () {\n    // IndexedDB\n    var indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.OIndexedDB || window.msIndexedDB,\n        IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.OIDBTransaction || window.msIDBTransaction,\n        dbVersion = 1.0;\n\n    // Create/open database\n    var request = indexedDB.open("elephantFiles", dbVersion),\n        db,\n        createObjectStore = function (dataBase) {\n            // Create an objectStore\n            console.log("Creating objectStore")\n            dataBase.createObjectStore("elephants");\n        },\n\n        getImageFile = function () {\n            // Create XHR\n            var xhr = new XMLHttpRequest(),\n                blob;\n\n            xhr.open("GET", "elephant.png", true);\n            // Set the responseType to blob\n            xhr.responseType = "blob";\n\n            xhr.addEventListener("load", function () {\n                if (xhr.status === 200) {\n                    console.log("Image retrieved");\n                    \n                    // Blob as response\n                    blob = xhr.response;\n                    console.log("Blob:" + blob);\n\n                    // Put the received blob into IndexedDB\n                    putElephantInDb(blob);\n                }\n            }, false);\n            // Send XHR\n            xhr.send();\n        },\n\n        putElephantInDb = function (blob) {\n            console.log("Putting elephants in IndexedDB");\n\n            // Open a transaction to the database\n            var transaction = db.transaction(["elephants"], IDBTransaction.READ_WRITE);\n\n            // Put the blob into the dabase\n            var put = transaction.objectStore("elephants").put(blob, "image");\n\n            // Retrieve the file that was just stored\n            transaction.objectStore("elephants").get("image").onsuccess = function (event) {\n                var imgFile = event.target.result;\n                console.log("Got elephant!" + imgFile);\n\n                // Get window.URL object\n                var URL = window.URL || window.webkitURL;\n\n                // Create and revoke ObjectURL\n                var imgURL = URL.createObjectURL(imgFile);\n\n                // Set img src to ObjectURL\n                var imgElephant = document.getElementById("elephant");\n                imgElephant.setAttribute("src", imgURL);\n\n                // Revoking ObjectURL\n                URL.revokeObjectURL(imgURL);\n            };\n        };\n\n    request.onerror = function (event) {\n        console.log("Error creating/accessing IndexedDB database");\n    };\n\n    request.onsuccess = function (event) {\n        console.log("Success creating/accessing IndexedDB database");\n        db = request.result;\n\n        db.onerror = function (event) {\n            console.log("Error creating/accessing IndexedDB database");\n        };\n        \n        // Interim solution for Google Chrome to create an objectStore. Will be deprecated\n        if (db.setVersion) {\n            if (db.version != dbVersion) {\n                var setVersion = db.setVersion(dbVersion);\n                setVersion.onsuccess = function () {\n                    createObjectStore(db);\n                    getImageFile();\n                };\n            }\n            else {\n                getImageFile();\n            }\n        }\n        else {\n            getImageFile();\n        }\n    }\n    \n    // For future use. Currently only in latest Firefox versions\n    request.onupgradeneeded = function (event) {\n        createObjectStore(event.target.result);\n    };\n})();\n\n\n')])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"浏览器支持"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#浏览器支持","aria-hidden":"true"}},[this._v("#")]),this._v(" 浏览器支持")])},function(){var e=this.$createElement,t=this._self._c||e;return t("p",[t("img",{attrs:{src:"401F5717CD934E3EB7A58F183F382743",alt:"image"}})])},function(){var e=this.$createElement,t=this._self._c||e;return t("p",[t("img",{attrs:{src:"AA17D5E1C0DA408CA69BA58E11565B84",alt:"image"}})])}],!1,null,null,null);t.default=a.exports}}]);